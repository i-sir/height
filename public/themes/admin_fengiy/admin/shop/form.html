<!--类型-->
<div class="form-group" style="display:none;">
    <label class="col-sm-2 control-label">类型:</label>
    <div class="layui-input-block col-sm-6">
        <foreach item="class_value" name="class_list">
            <input class="form-control post-params" lay-skin="tag" name="class_ids[{$class_value.id}]"
                   title="{$class_value.name}"
                   type="checkbox"
            <if condition="in_array($class_value.id,$class_ids)">
                checked
            </if>
            >
        </foreach>
    </div>
</div>


<!--店铺名字-->
<div class="form-group">
    <label class="col-sm-2 control-label">名称:</label>
    <div class="layui-input-block col-sm-6">
        <input type="text" name="name" class="form-control post-params item-left" value="{$name|default=''}">
    </div>
</div>


<!--logo-->
<div class="form-group">
    <label class="col-sm-2 control-label">logo:</label>
    <div class="layui-input-block col-sm-6">
        <input type="hidden" class="form-control post-params item-left" name="logo_image" id="photo-0000003"
               value="{$logo_image}">
        <if condition='!empty($logo_image)'>
            <a href="javascript:imagePreviewDialog('{:cmf_get_asset_url($logo_image)}');">
                <img src='{:cmf_get_image_preview_url($logo_image)}' id='photo-0000003-preview' style='width: 85px;'>
            </a>
            <else/>
            <img src='/static/images/default.png' id='photo-0000003-preview' style='width: 85px;'>
        </if>
        <a href="javascript:uploadOneImage('图片上传','#photo-0000003','image');">上传</a>
        <a onclick="$('#photo-0000003-preview').attr('src','__TMPL__/public/assets/images/default-thumbnail.png');$('#photo-0000003').val('');return false;">取消图片</a>
    </div>
</div>


<!--轮播图-->
<div class="form-group" style="display:none;">
    <label class="col-sm-2 control-label">轮播图:</label>
    <div class="layui-input-block col-sm-6">
        <div class="help-block text-danger">长按图片可上下拖动,调整图片顺序</div>
        <if condition="!empty($images)">
            <ul id="imagesId00000004" class="pic-list list-unstyled form-inline">
                <foreach name="$images" item="vo">
                    <li id="savedImages-00000004-{$key}" style="margin-bottom: 5px;">
                        <input id="photoImages-00000004-{$key}" class="form-control post-params item-left" type="hidden"
                               name="images[{$key}]" value="{$vo}">
                        <img id="photoImages-00000004-{$key}-preview" src="{:cmf_get_image_preview_url($vo)}"
                             height="50" onclick="parent.imagePreviewDialog(this.src);">
                        <a href="javascript:uploadOneImage('图片上传','#photoImages-00000004-{$key}');">替换</a>
                        <a href="javascript:(function(){$('#savedImages-00000004-{$key}').remove();})();">移除</a>
                    </li>
                </foreach>
            </ul>
            <else/>
            <ul id="imagesId00000004" class="pic-list list-unstyled form-inline">
                <li id="savedImages-00000004" style="margin-bottom: 5px;">
                </li>
            </ul>
        </if>
        <a href="javascript:uploadMultiImage('图片上传','#imagesId00000004','itemImages-00000004');"
           class="btn btn-sm btn-default">选择图片</a>
        <script type="text/html" id="itemImages-00000004">
            <li id="savedImages-00000004-{id}" style="margin-bottom: 5px;">
                <input id="photoImages-00000004-{id}" class="form-control post-params item-left" type="hidden"
                       name="images[{id}]" value="{filepath}">
                <img id="photoImages-00000004-{id}-preview" src="{url}" height="50"
                     onclick="imagePreviewDialog(this.src);">
                <a href="javascript:uploadOneImage('图片上传','#photoImages-00000004-{id}');">替换</a>
                <a href="javascript:(function(){$('#savedImages-00000004-{id}').remove();})();">移除</a>
            </li>
        </script>
        <script>
            // 多图上传支持排序
            new Sortable(imagesId00000004, {
                animation: 150,
                ghostClass: 'blue-background-class'
            });
        </script>
    </div>
</div>


<!--视频-->
<div class="form-group">
    <label class="col-sm-2 control-label">视频:</label>
    <div class="layui-input-block col-sm-6">
        <input type="text" class="form-control post-params item-left" name="video" id="video-0000005"
               readonly="readonly" value="{$video}">
        <if condition='!empty($video)'>
            <a id="video-0000005-preview" href="{:cmf_get_file_download_url($video)}"
               target="_blank">下载</a>
        </if>
        <a href="javascript:uploadOne('视频上传','#video-0000005','video');">上传</a>
        <a onclick="$('#video-0000005').val('');return false;">取消</a>
    </div>
</div>


<!--手机号-->
<div class="form-group">
    <label class="col-sm-2 control-label">手机号:</label>
    <div class="layui-input-block col-sm-6">
        <input type="text" name="phone" class="form-control post-params item-left" value="{$phone|default=''}">
    </div>
</div>


<!--营业时间-->
<div class="form-group">
    <label class="col-sm-2 control-label">营业时间:</label>
    <div class="layui-input-block col-sm-6">
        <input type="text" name="time" class="form-control post-params item-left" value="{$time|default=''}">
    </div>
</div>





<div class="form-group">
    <div class="layui-form-item">
        <label class="col-sm-2 control-label">地区:</label>
        <div class="col-md-6 col-sm-10" style="">
            <div class="layui-inline">
                <select class="province_code" lay-filter="province_code" lay-search lay-verify="required"
                        name="province_code">
                    <option value="{$province_code}">{$province}</option>
                </select>
            </div>
            <div class="layui-inline">
                <select class="city_code" lay-filter="city_code" lay-search lay-verify="required" name="city_code">
                    <option value="{$city_code}">{$city}</option>
                </select>
            </div>
            <div class="layui-inline">
                <select class="county_code" lay-search lay-filter="county_code" lay-verify="required"
                        name="county_code">
                    <option value="{$county_code}">{$county}</option>
                </select>
            </div>
        </div>
    </div>
    <!--地区三级联动 layui-->
    <script>
        /**
         *


         -----数据库字段名----
         province:省
         city:市
         county:区
         province_code:省code
         city_code:市code
         county_code:区code
         可有可无字段:
         province_id:省id
         city_id:市id
         county_id:区id
         lnglat:经纬度
         lng:经度
         lat:纬度




         ------后台控制器增加方法-----

         public function getArea()
         {
        if (cache('admin_region_list')) {
            $area = cache('admin_region_list');
        } else {
            $area = Db::name('region')->where('parent_id', '=', 10000000)->field('id,name,code')->select()->each(function ($item, $key) {
                $item['cityList'] = Db::name("region")->where(['parent_id' => $item['id']])->field('id,name,code')->select()->each(function ($item1, $key) {
                    $item1['areaList'] = Db::name("region")->where(['parent_id' => $item1['id']])->field('id,name,code')->select()->each(function ($item2, $key) {
                        return $item2;
                    });
                    return $item1;
                });
                return $item;
            });
            cache("admin_region_list", $area);
        }
        $this->success('list', '', $area);
    }


         -----编辑处理数据----

         //经纬度单独存
         $lnglat        = explode(',', $params['lnglat']);
         $params['lng'] = $lnglat[0];//经度
         $params['lat'] = $lnglat[1];//纬度
         //省市区基本信息
         $province_info = Db::name('region')->where('code', '=', $params['province_code'])->find();
         $city_info     = Db::name('region')->where('code', '=', $params['city_code'])->find();
         $county_info   = Db::name('region')->where('code', '=', $params['county_code'])->find();
         //name
         $params['province'] = $province_info['name'];
         $params['city']     = $city_info['name'];
         $params['county']   = $county_info['name'];
         //id
         $params['province_id'] = $province_info['id'];
         $params['city_id']     = $city_info['id'];
         $params['county_id']   = $county_info['id'];

         **/


        layui.use(['form', 'element'], function () {
            var form = layui.form,
                element = layui.element;
            var provinceList;
            $.ajax({
                url: "{:url('getArea')}",
                type: "GET",
                async: false,
                success: function (res) {
                    //console.log(res);
                    if (res.code == 1) {
                        provinceList = res.data;
                    } else {
                        layer.msg(res.msg, {icon: 7});
                    }
                }
            });

            var province = $(".province_code");

            //初始将省份数据赋予
            for (var i = 0; i < provinceList.length; i++) {
                addEle(province, provinceList[i].name, provinceList[i].code);
            }

            //向select中 追加内容
            function addEle(ele, value, code) {
                var optionStr = "";
                optionStr = "<option value=" + code + " >" + value + "</option>";
                ele.append(optionStr);
            }

            //重新渲染select
            form.render('select');

            //移除select中所有项
            function removeEle(ele) {
                ele.find("option").remove();
                var optionStar = "<option value=''>" + "请选择" + "</option>";
                ele.append(optionStar);
            }

            var provinceText,
                cityText,
                cityItem;
            //选定省份后 将该省份的数据读取追加上
            form.on('select(province_code)', function (data) {
                console.log(data);
                var city = $(data.elem).parents(".layui-form-item").find(".city_code"),
                    district = $(data.elem).parents(".layui-form-item").find(".county_code");
                provinceText = data.value;

                $.each(provinceList, function (i, item) {
                    if (provinceText == item.code) {
                        cityItem = i;
                        return cityItem;
                    }
                });
                removeEle(city);
                removeEle(district);
                $.each(provinceList[cityItem].cityList, function (i, item) {
                    addEle(city, item.name, item.code);
                })
                form.render('select');
            })

            //选定后 将对应的数据读取追加上
            form.on('select(city_code)', function (data) {
                var district = $(data.elem).parents(".layui-form-item").find(".county_code");
                cityText = data.value;
                removeEle(district);
                $.each(provinceList, function (i, item) {
                    if (provinceText == item.code) {
                        cityItem = i;
                        return cityItem;
                    }
                });
                $.each(provinceList[cityItem].cityList, function (i, item) {
                    if (cityText == item.code) {
                        for (var n = 0; n < item.areaList.length; n++) {
                            addEle(district, item.areaList[n]['name'], item.areaList[n]['code']);
                        }
                    }
                })
                form.render('select');
            })
        })
    </script>
</div>
<div class="form-group">
    <label class="col-sm-2 control-label">地址</label>
    <div class="col-md-6 col-sm-10">
        <div style="display: flex;">
            <input class="form-control post-params item-left" id="address" name="address"
                   onblur="searchAddress()"
                   placeholder="请输入详细地址" required
                   type="text" value="{$address}">
            <a class="btn btn-primary" href="javascript:" onclick="searchAddress()"
               style="margin-left: 10px;">搜索</a>
        </div>
        <div id="container" style="margin-top:10px;width:800px;height:400px;"></div>
    </div>
</div>
<div class="form-group">
    <label class="col-sm-2 control-label">经纬度</label>
    <input class="form-control post-params item-left" id="lng" name="lng" type="hidden" value="{$lng}">
    <input class="form-control post-params item-left" id="lat" name="lat" type="hidden" value="{$lat}">
    <div class="col-md-6 col-sm-10">
        <input class="form-control post-params" id="lnglat" name="lnglat" placeholder="" readonly required
               type="text"
               value="{$lnglat}">
    </div>
</div>
<!--
控制器

----- 插入处理数据方法 -----
     edit_post方法:

     //经纬度单独存
     $lnglat        = explode(',', $params['lnglat']);
     $params['lng'] = $lnglat[0];//经度
     $params['lat'] = $lnglat[1];//纬度
     //省市区基本信息
     $province_info = Db::name('region')->where('code', '=', $params['province_code'])->find();
     $city_info     = Db::name('region')->where('code', '=', $params['city_code'])->find();
     $county_info   = Db::name('region')->where('code', '=', $params['county_code'])->find();
     //name
     $params['province'] = $province_info['name'];
     $params['city']     = $city_info['name'];
     $params['county']   = $county_info['name'];
     //id
     $params['province_id'] = $province_info['id'];
     $params['city_id']     = $city_info['id'];
     $params['county_id']   = $county_info['id'];


    本控制器增加三个方法
     public function getArea()
    {
        if (cache('admin_region_list')) {
            $area = cache('admin_region_list');
        } else {
            $area = Db::name('region')->where('parent_id', '=', 10000000)->field('id,name,code')->select()->each(function ($item, $key) {
                $item['cityList'] = Db::name("region")->where(['parent_id' => $item['id']])->field('id,name,code')->select()->each(function ($item1, $key) {
                    $item1['areaList'] = Db::name("region")->where(['parent_id' => $item1['id']])->field('id,name,code')->select()->each(function ($item2, $key) {
                        return $item2;
                    });
                    return $item1;
                });
                return $item;
            });
            cache("admin_region_list", $area);
        }
        $this->success('list', '', $area);
    }




    /**
     * 地址转换为坐标(高德地图)
     */
    public function search_address_ii()
    {
        $address = $this->request->param('address');
        $key     = "0f7cbfb881a2bea61d912a4cc920b663";

        $url    = "https://restapi.amap.com/v3/geocode/geo?address={$address}&key={$key}";
        $result = file_get_contents($url);
        $result = json_decode($result, true);
        if ($result['status'] == 1) {

            $geocodes = $result['geocodes'];
            $return   = [];
            foreach ($geocodes as $item) {
                $location = explode(',', $item['location']);
                $return[] = ['lon' => $location[0], 'lat' => $location[1]];
            }
            $this->success('', '', $return);
        } else {
            $this->success('', '', $result['info']);
        }
    }

    /**
     * 坐标转换地址(高德地图)
     */
    public function reverse_address_ii()
    {
        $lng = $this->request->param('lng');
        $lat = $this->request->param('lat');
        $key = "0f7cbfb881a2bea61d912a4cc920b663";
        $url = "https://restapi.amap.com/v3/geocode/regeo?location={$lng},{$lat}&key={$key}";

        $result = file_get_contents($url);
        $result = json_decode($result, true);
        if ($result['status'] == 1) {

            $regeocode         = $result['regeocode'];
            $formatted_address = $regeocode['formatted_address'];
            $this->success('', '', $formatted_address);
        } else {
            $this->success('', '', $result['info']);
        }
    }



    计算距离
    $field_lat = 'lat';// 数据库字段名 - 纬度  -90°到90°
    $field_lng = 'lng';// 数据库字段名 - 经度  -180°到180°
    $lat       = $params['lat'];// 数据库字段名 - 纬度  -90°到90°
    $lng       = $params['lng'];// 数据库字段名 - 经度  -180°到180°
    if (!empty($lat) && !empty($lng)) {
        $field           = "*, (6378.138 * 2 * asin(sqrt(pow(sin(({$field_lng} * pi() / 180 - {$lng} * pi() / 180) / 2),2) + cos({$field_lng} * pi() / 180) * cos({$lng} * pi() / 180) * pow(sin(({$field_lat} * pi() / 180 - {$lat} * pi() / 180) / 2),2))) * 1000) as distance";
        $params['order'] = 'distance asc,id desc';
        $params['field'] = $field;


        //方法2 规定距离范围
        // ->field("*")
        //            ->field("{$distanceFormula} as distance")
        //            ->having("distance BETWEEN 10000 AND 20000")
        //            ->order('distance')
        //            ->select();
    }

    //$item['distance']  = '0km';
    if ($item['distance']) $item['distance'] = round($item['distance'] / 100, 2) . 'km';
 -->









<!--介绍-->
<div class="form-group">
    <label class="col-sm-2 control-label">介绍:</label>
    <div class="layui-input-block col-sm-6">
        <script type="text/plain" id="content" name="content">
            {:cmf_replace_content_file_url(htmlspecialchars_decode($content))}
        </script>
        <script type="text/javascript">
            //编辑器路径定义
            var editorURL = GV.WEB_ROOT;
        </script>
        <script type="text/javascript" src="/static/js/ueditor/ueditor.config.js?v=00001"></script>
        <script type="text/javascript" src="/static/js/ueditor/ueditor.all.min.js"></script>
        <!--编辑器支持秀米-->
        <script type="text/javascript" src="/static/js/ueditor/xiumi/xiumi-ue-dialog-v5.js"></script>
        <link rel="stylesheet" type="text/css" href="/static/js/ueditor/xiumi/xiumi-ue-v5.css"/>
        <script type="text/javascript">
            $(function () {
                editorcontent = new baidu.editor.ui.Editor();
                editorcontent.render('content');
                try {
                    editorcontent.sync();
                } catch (err) {
                }
            });
        </script>
    </div>
</div>





<!--高德地图板块-->
<script src="https://webapi.amap.com/maps?v=1.4.15&key=0f7cbfb881a2bea61d912a4cc920b663"></script>
<script>

    //定义地图中心点坐标
    var already_lat = $("#lat").val();
    var already_lng = $("#lng").val();

    if (already_lat == '') {
        already_lat = 39.916706;
        already_lng = 116.403119;
    }

    var map = new AMap.Map('container', {
        center: [already_lng, already_lat],
        zoom: 16
    });

    var marker;
    //设置圆形位置
    // var center = new AMap.LngLat(already_lng, already_lat);
    //设置圆的半径大小
    // var radius = $("#delivery_distance").val() //单位:px
    // radius = radius * 1000

    //创建圆形 Circle 实例
    // var circle = new AMap.Circle({
    //     center: center, //圆心
    //     radius: radius, //半径
    //     borderWeight: 3, //描边的宽度
    //     strokeColor: "", //轮廓线颜色
    //     strokeOpacity: 1, //轮廓线透明度
    //     strokeWeight: 6, //轮廓线宽度
    //     fillOpacity: 0.4, //圆形填充透明度
    //     strokeStyle: "dashed", //轮廓线样式
    //     strokeDasharray: [10, 10],
    //     fillColor: "#1791fc", //圆形填充颜色
    //     zIndex: 50, //圆形的叠加顺序
    // });

    //圆形 Circle 对象添加到 Map
    //map.add(circle);//不需要画圆
    //根据覆盖物范围调整视野
    //map.setFitView([circle]);//这里也不需要覆盖


    map.on('click', function (e) {
        // console.log(e)
        // console.log('cccccccccccc')
        var lng = e.lnglat.lng
        var lat = e.lnglat.lat

        let url = "{:url('reverse_address_ii')}";
        $.get(url, {lng: lng, lat: lat}, function (res) {
            // debugger;
            //console.log(res)
            if (res.code == 1) {
                let address = res.data;
                $("#lnglat").val(lng + "," + lat);
                $("#address").val(address);
                addMarker(lng, lat);
            } else {
                layer.msg(res.msg);
            }
        });

    });

    addMarker(already_lng, already_lat)

    function searchAddress() {
        var province_code = $("#province_code option:selected").text();
        var city_code = $("#city_code option:selected").text();
        var district = $("#county_code option:selected").text();

        // if(province_code == '请选择'){
        //     layer.msg('请选择地区');
        //     return;
        // }
        // if(city_code == '请选择' || district == '请选择'){
        //     layer.msg('请选择地区');
        //     return;
        // }
        let address = $("#address").val();
        var full_address = province_code + city_code + district + address;//可以根据具体位置直接搜索
        let url = "{:url('search_address_ii')}";
        $.get(url, {address: full_address}, function (res) {
            // debugger;
            if (res.code == 1) {
                let location = res.data;
                console.log(location)
                $("#lnglat").val(location[0].lon + "," + location[0].lat);
                addMarker(location[0].lon, location[0].lat);//画图标
            } else {
                layer.msg(res.msg);
            }
        });
    }

    function addMarker(lng, lat) {
        console.log(11)
        clearMarker();
        var position = new AMap.LngLat(lng, lat);

        map.setCenter([lng, lat])
        marker = new AMap.Marker({
            //icon: "//a.amap.com/jsapi_demos/static/demo-center/icons/poi-marker-red.png",
            position: position,
        });
        map.add(marker);
    }

    //移除marker事件
    function clearMarker() {
        if (marker) {
            marker.setMap(null);
            marker = null;
        }
    }
</script>




